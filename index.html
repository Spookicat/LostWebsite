<!DOCTYPE html>
<html lang="en">
<head>
    <title>I was lost once too</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Open+Sans">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>

    <script src="lib/three.js"></script>
    <script src="lib/gsap.min.js"></script>
    <script src="lib/Tone.js"></script>
    <script src="lib/postprocessing/EffectComposer.js"></script>
    <script src="lib/postprocessing/MaskPass.js"></script>
    <script src="lib/postprocessing/RenderPass.js"></script>
    <script src="lib/postprocessing/ShaderPass.js"></script>
    <script src="lib/shaders/CopyShader.js"></script>
    <script src="lib/shaders/FilmShader.js"></script>
    <script src="lib/shaders/FXAAShader.js"></script>
    <script src="lib/shaders/RGBShiftShader.js"></script>

    <div id="parent">
        <form id="mysteryform" autocomplete="off">
            <input id="mysteriousbox" type="text" />
        </form>
    </div>

    <script type="module">
        var camera, scene, renderer;
        var composer;
		var shaderTime = 0;
		var rgbParams, rgbPass;
		var filmParams, filmPass;
        var renderPass, copyPass;
        var fxaaPass;

        var submitting;
        var displayText;

        var funTones = ["C3","D3","E3","F3","G3","A3","B3"];
        var scareTones =["C#2","D#2","F#2","G#1","A#1"];

        //const panner = new Tone.Panner3D();
        //panner.set({panningModel: "HRTF"});

        const funSynth = new Tone.Synth();
        const scareSynth = new Tone.DuoSynth();

        // funSynth effects
        //const autoPanner = new Tone.AutoPanner("2n").start();
        const feedbackDelay = new Tone.FeedbackDelay(.475, 0.5);
        const reverb = new Tone.Reverb(4.5);

        // scareSynth effects
        const crusher = new Tone.BitCrusher(4);
        const distortion = new Tone.Distortion(0.1);
        //const scareVerb = new Tone.JCReverb(0.8);
        const EQ = new Tone.EQ3(-3, -5, -10);


        funSynth.envelope.set({attack: 0.1})
        feedbackDelay.set( {wet: 0.5} );
        reverb.set( {wet: 0.7} );
        
        scareSynth.set( {volume : -18, detune: -3, voice1: {detune: -5}, voice2: {detune: -9}} );
        
        funSynth.chain(feedbackDelay, reverb, Tone.Destination);
        scareSynth.chain(crusher, distortion, reverb, EQ, Tone.Destination);

        function processText(e)
        {
            if(Tone.context.state != 'running'){
                Tone.start();
            }
            if(e.preventDefault) e.preventDefault();

            var phrase = document.getElementById("mysteriousbox").value.toLowerCase();
            var form = this;
            var font = 'fonts/Oswald_Medium.typeface.json';
            var scary = false;
            var text;

            if(!submitting){
                switch(phrase){
                    case "spookicat":
                        displayText = "You've heard it too?";
                        submitting = true;
                        break;
                    case "please kill me":
                        font = 'fonts/DOS_Win_Regular.typeface.json';
                        displayText = "Okay.";
                        submitting = true;
                        scary = true;
                        break;
                    case "something":
                        return;
                    default:
                        displayText = "You're lost aren't you?"
                        submitting = true;
                }
                displayResponse(font, scary);
            }
            return false;
        }

        var form = document.getElementById('mysteryform');

        if(form.attachEvent){
            form.attachEvent("submit", processText);
        }   else{
            form.addEventListener("submit", processText);
        }

        function displayResponse( textFont, scary )
        {
            var loader = new THREE.FontLoader();
            loader.load(textFont, function (font) {

                var textGeo = new THREE.TextGeometry(displayText, {
                    font: font,
                    size: 10,
                    height: 0.1,
                    curveSegments: 12,
                });
                
                textGeo.computeBoundingBox();
                //textGeo.computeVertexNormals();

                var centerOffset = - 0.5 * ( textGeo.boundingBox.max.x - textGeo.boundingBox.min.x );
                var textMat;

                if(scary)
                {
                    enableShaders();
                    textMat = new THREE.MeshPhongMaterial({color: 0xFFFF00, emissive: 0x2a2a2a, emissiveIntensity: .5});     
                }
                else{
                    disableShaders();
                    textMat = new THREE.MeshPhongMaterial({color: 0xFFFFFF, emissive: 0x2a2a2a, emissiveIntensity: .5});
                }

                var textMesh = new THREE.Mesh(textGeo, textMat);
                textMesh.name = "text";
                textMesh.position.z = -170;
                textMesh.position.x = centerOffset;
                textMesh.position.y = -22;

                textMesh.rotation.x = 0;
                textMesh.rotation.y = Math.PI * 2;
                textMesh.material.transparent = true;
                textMesh.material.opacity = 1;

                scene.add(textMesh);

                animateText(textMesh, scary);
            });
        }

        function animateText(textMesh, scary)
        {
            var duration = 1;
            if (scary)
            {
                var newX = textMesh.position.x;
                var newY = textMesh.position.y - 10;
                var newZ = textMesh.position.z - 50;
            
                playScareSound();
            }
            else
            {
                var newX = Math.floor(Math.random() * 400) - 200;
                var newY = Math.floor(Math.random() * 80);
                var newZ = Math.floor(Math.random() * 200) - 400;

                playFunSound();
            }

            var tl = gsap.timeline({onComplete: removeEntity, onCompleteParams:["text"]});
            tl.from(textMesh.material, duration+1, {opacity: 0, ease:"slow"});
            tl.from(textMesh.position, duration, {x: newX, z: newZ, ease:"power2"},0);
            tl.from(textMesh.position, duration-0.5, {y: newY, ease:"power1"},0);

            var n = displayText.length/10;
            tl.to(textMesh.material, 1, {opacity:0}), '+=${n}';
        }

        function removeEntity(object)
        {
            var selectedObject = scene.getObjectByName(object);
            scene.remove( selectedObject );
            submitting = false;
            animate();
        }

        function playFunSound()
        {
            funSynth.triggerAttackRelease(funTones[Math.floor(Math.random() * 7)], "16n", Tone.context.currentTime);
        }

        function playScareSound()
        {
            scareSynth.triggerAttackRelease(scareTones[Math.floor(Math.random() * 5)], "3n", Tone.context.currentTime);
        }

        function init()
        {
            // init camera
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
            camera.position.z = 5;

            // init renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );

            //POST PROCESSING
			//Create Shader Passes
			renderPass = new THREE.RenderPass(scene, camera);
			rgbPass = new THREE.ShaderPass(THREE.RGBShiftShader);
			filmPass = new THREE.ShaderPass(THREE.FilmShader);
            copyPass = new THREE.ShaderPass(THREE.CopyShader);
            fxaaPass = new THREE.ShaderPass(THREE.FXAAShader);

			//set shader uniforms
			filmPass.uniforms.grayscale.value = 0;

            // init shader params
            rgbParams = {
                show: false,
                amount: 0.0014,
                angle: 1
            };

            filmParams = {
                show: false,
                count: 4096,
                sIntensity: 0.6,
                nIntensity: 1
            }
            
            // init Ambient Light
            var light = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(light);
            
            // init Point Light (pointing downwardly at the text)
            var light2 = new THREE.PointLight(0xdddddd, 0.5);
            light2.position.y = 250;
            scene.add(light2);

            // -------init submitting bool--------
            // # gatekeeps user input submission #
            //  ----------------------------------
            submitting = false;

            onToggleShaders();
            onParamsChange();

            window.addEventListener('resize', () => {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;

                camera.updateProjectionMatrix();

                fxaaPass.material.uniforms[ 'resolution' ].value.x = 1 / ( window.innerWidth * pixelRatio );
                fxaaPass.material.uniforms[ 'resolution' ].value.y = 1 / ( window.innerHeight * pixelRatio );

            })
        }

        function enableShaders()
        {
            rgbParams.show = true;
            filmParams.show = true;

            onToggleShaders();
        }

        function disableShaders()
        {
            rgbParams.show = false;
            filmParams.show = false;

            onToggleShaders();
        }

        function onParamsChange() {

            //copy gui params into shader uniforms
            rgbPass.uniforms['angle'].value = rgbParams.angle * Math.PI;
            rgbPass.uniforms['amount'].value = rgbParams.amount;

            filmPass.uniforms['sCount'].value = filmParams.count;
            filmPass.uniforms['sIntensity'].value = filmParams.sIntensity;
            filmPass.uniforms['nIntensity'].value = filmParams.nIntensity;
        }

        function onToggleShaders() {

            //Add Shader Passes to Composer
            //order is important 
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderPass);

            if (filmParams.show) {
                composer.addPass(filmPass);
            }

            if (rgbParams.show) {
                composer.addPass(rgbPass);
            }

            const pixelRatio = renderer.getPixelRatio();

            fxaaPass.material.uniforms[ 'resolution' ].value.x = 1 / ( window.innerWidth * pixelRatio );
            fxaaPass.material.uniforms[ 'resolution' ].value.y = 1 / ( window.innerHeight * pixelRatio );

            composer.addPass(fxaaPass);
            fxaaPass.renderToScreen = true;
        }

        var animate = function () {
            shaderTime += 0.1;
			filmPass.uniforms['time'].value = shaderTime;

            requestAnimationFrame( animate );

            render();
        }

        function render() {
            composer.render(0.1);
        }
    
        init();
        animate();
    </script>

</body>
</html>